# PM2 ç®¡ç†æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

PM2æ˜¯ä¸€ä¸ªå¼ºå¤§çš„Node.jsè¿›ç¨‹ç®¡ç†å™¨ï¼Œç”¨äºç®¡ç†Asterå¯¹å†²äº¤æ˜“å·¥å…·çš„è¿è¡Œã€‚å®ƒæä¾›äº†è‡ªåŠ¨é‡å¯ã€æ—¥å¿—ç®¡ç†ã€ç›‘æ§ç­‰åŠŸèƒ½ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…PM2
```bash
# å…¨å±€å®‰è£…PM2
npm install -g pm2

# æˆ–è€…å®‰è£…é¡¹ç›®ä¾èµ–
npm install
```

### 2. å¯åŠ¨åº”ç”¨
```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨
npm run pm2:start

# æˆ–è€…ç›´æ¥ä½¿ç”¨PM2å‘½ä»¤
pm2 start ecosystem.config.js
```

## ğŸ“ å¸¸ç”¨å‘½ä»¤

### åŸºç¡€ç®¡ç†
```bash
# å¯åŠ¨åº”ç”¨
npm run pm2:start

# åœæ­¢åº”ç”¨
npm run pm2:stop

# é‡å¯åº”ç”¨
npm run pm2:restart

# é‡è½½åº”ç”¨ï¼ˆé›¶åœæœºæ—¶é—´ï¼‰
npm run pm2:reload

# åˆ é™¤åº”ç”¨
npm run pm2:delete
```

### ç›‘æ§å’Œæ—¥å¿—
```bash
# æŸ¥çœ‹åº”ç”¨çŠ¶æ€
npm run pm2:status

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
npm run pm2:logs

# æ‰“å¼€ç›‘æ§é¢æ¿
npm run pm2:monit

# æ¸…ç©ºæ—¥å¿—
npm run pm2:flush
```

### é«˜çº§å‘½ä»¤
```bash
# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
pm2 describe aster-hedge-tool

# æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯
pm2 show aster-hedge-tool

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save

# æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹
pm2 list

# åœæ­¢æ‰€æœ‰è¿›ç¨‹
pm2 stop all

# é‡å¯æ‰€æœ‰è¿›ç¨‹
pm2 restart all
```

## âš™ï¸ é…ç½®æ–‡ä»¶è¯´æ˜

### ecosystem.config.js ä¸»è¦é…ç½®é¡¹

```javascript
{
  name: 'aster-hedge-tool',        // åº”ç”¨åç§°
  script: 'index.js',             // å¯åŠ¨è„šæœ¬
  instances: 1,                    // å®ä¾‹æ•°é‡
  autorestart: true,              // è‡ªåŠ¨é‡å¯
  watch: false,                    // æ–‡ä»¶ç›‘æ§
  max_memory_restart: '1G',       // å†…å­˜é™åˆ¶
  env: {                          // ç¯å¢ƒå˜é‡
    NODE_ENV: 'production'
  }
}
```

### æ—¥å¿—é…ç½®
- `log_file`: åˆå¹¶æ—¥å¿—æ–‡ä»¶
- `out_file`: æ ‡å‡†è¾“å‡ºæ—¥å¿—
- `error_file`: é”™è¯¯æ—¥å¿—
- `log_date_format`: æ—¥å¿—æ—¶é—´æ ¼å¼

### è¿›ç¨‹ç®¡ç†
- `min_uptime`: æœ€å°è¿è¡Œæ—¶é—´
- `max_restarts`: æœ€å¤§é‡å¯æ¬¡æ•°
- `restart_delay`: é‡å¯å»¶è¿Ÿ

## ğŸ“Š ç›‘æ§åŠŸèƒ½

### 1. å®æ—¶ç›‘æ§
```bash
pm2 monit
```
æ˜¾ç¤ºCPUã€å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œè¿›ç¨‹çŠ¶æ€ç­‰ã€‚

### 2. æ—¥å¿—ç®¡ç†
```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
pm2 logs aster-hedge-tool

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs aster-hedge-tool --err

# æŸ¥çœ‹è¾“å‡ºæ—¥å¿—
pm2 logs aster-hedge-tool --out
```

### 3. çŠ¶æ€æ£€æŸ¥
```bash
pm2 status
```
æ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ã€‚

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **åº”ç”¨æ— æ³•å¯åŠ¨**
   ```bash
   # æ£€æŸ¥æ—¥å¿—
   pm2 logs aster-hedge-tool --err
   
   # æ£€æŸ¥é…ç½®æ–‡ä»¶
   pm2 describe aster-hedge-tool
   ```

2. **å†…å­˜ä½¿ç”¨è¿‡é«˜**
   ```bash
   # é‡å¯åº”ç”¨
   pm2 restart aster-hedge-tool
   
   # æ£€æŸ¥å†…å­˜ä½¿ç”¨
   pm2 monit
   ```

3. **é¢‘ç¹é‡å¯**
   ```bash
   # æŸ¥çœ‹é‡å¯å†å²
   pm2 show aster-hedge-tool
   
   # è°ƒæ•´é‡å¯ç­–ç•¥
   # ç¼–è¾‘ ecosystem.config.js
   ```

### æ—¥å¿—ä½ç½®
- åº”ç”¨æ—¥å¿—: `./logs/aster-tool-*.log`
- PM2æ—¥å¿—: `./logs/pm2-*.log`

## ğŸ›¡ï¸ å®‰å…¨å»ºè®®

1. **ç”Ÿäº§ç¯å¢ƒé…ç½®**
   - è®¾ç½®åˆé€‚çš„ `max_memory_restart`
   - é…ç½® `min_uptime` é˜²æ­¢é¢‘ç¹é‡å¯
   - å¯ç”¨æ—¥å¿—è½®è½¬

2. **ç›‘æ§è®¾ç½®**
   - å®šæœŸæ£€æŸ¥åº”ç”¨çŠ¶æ€
   - è®¾ç½®å†…å­˜å’ŒCPUç›‘æ§
   - é…ç½®å‘Šè­¦é€šçŸ¥

3. **å¤‡ä»½ç­–ç•¥**
   - å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶
   - ä¿å­˜é‡è¦çš„æ—¥å¿—æ–‡ä»¶
   - å¤‡ä»½APIå¯†é’¥é…ç½®

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **å†…å­˜ç®¡ç†**
   - è®¾ç½®åˆç†çš„å†…å­˜é™åˆ¶
   - ç›‘æ§å†…å­˜æ³„æ¼
   - å®šæœŸé‡å¯åº”ç”¨

2. **æ—¥å¿—ç®¡ç†**
   - å®šæœŸæ¸…ç†æ—§æ—¥å¿—
   - ä½¿ç”¨æ—¥å¿—è½®è½¬
   - åˆ†ç¦»é”™è¯¯å’Œæ™®é€šæ—¥å¿—

3. **è¿›ç¨‹ç®¡ç†**
   - é¿å…è¿‡åº¦é‡å¯
   - è®¾ç½®åˆç†çš„é‡å¯å»¶è¿Ÿ
   - ç›‘æ§è¿›ç¨‹å¥åº·çŠ¶æ€

## ğŸ”„ éƒ¨ç½²æµç¨‹

### å¼€å‘ç¯å¢ƒ
```bash
npm run pm2:start
npm run pm2:logs
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
# 1. åœæ­¢å½“å‰åº”ç”¨
pm2 stop aster-hedge-tool

# 2. æ›´æ–°ä»£ç 
git pull origin main

# 3. å®‰è£…ä¾èµ–
npm install

# 4. é‡å¯åº”ç”¨
pm2 restart aster-hedge-tool

# 5. æ£€æŸ¥çŠ¶æ€
pm2 status
```

## ğŸ“ æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. åº”ç”¨æ—¥å¿—æ–‡ä»¶
2. PM2çŠ¶æ€ä¿¡æ¯
3. ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
4. ç½‘ç»œè¿æ¥çŠ¶æ€

---

**æ³¨æ„**: è¯·ç¡®ä¿åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ­£ç¡®é…ç½®APIå¯†é’¥å’Œä»£ç†è®¾ç½®ï¼Œå¹¶å®šæœŸç›‘æ§åº”ç”¨è¿è¡ŒçŠ¶æ€ã€‚
